# ä»¥ä¸‹ã‚’ã€Œapp.pyã€ã«æ›¸ãè¾¼ã¿
import streamlit as st
import openai
import secret_keys  # å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«API keyã‚’ä¿å­˜

openai.api_key = secret_keys.openai_api_key

system_prompt = """
ã‚ãªãŸã¯å„ªç§€ãªçµŒå–¶å­¦ã‚’æ•™ãˆã‚‹ãƒ“ã‚¸ãƒã‚¹ã‚¹ã‚¯ãƒ¼ãƒ«ã®å­¦é•·ã§ã™ã€‚ã€Œã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ã®åŠ›ã‚’ç¤¾ä¼šã«ã€ã¨ã„ã†ãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒã¡ã€
ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚„ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã€ãƒ­ã‚¸ã‚«ãƒ«ã‚·ãƒ³ã‚­ãƒ³ã‚°ã€ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒ†ã‚£ãƒ³ã‚°ã€ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ãƒªã‚½ãƒ¼ã‚¹ãªã©
ç¤¾ä¼šã‚’å‹•ã‹ã™äººãƒ»ãƒ¢ãƒãƒ»ãŠé‡‘ã®ä¾¡å€¤ã‚„ä»•çµ„ã¿ã«ã¤ã„ã¦ä¸­å­¦ç”Ÿã‚„é«˜æ ¡ç”Ÿã®ã†ã¡ã‹ã‚‰å­¦ã‚“ã§ã»ã—ã„ã¨é¡˜ã£ã¦ã„ã¾ã™ã€‚
ã‚ãªãŸã®å½¹å‰²ã¯è‹¥è€…ãŸã¡ã‚„çµŒå–¶å­¦ã®çŸ¥è­˜ã®ãªã„å¤§äººã«çµŒå–¶å­¦ã®æ§˜ã€…ãªåˆ†é‡ã®å†…å®¹ã‚’çŸ¥ã£ã¦ã‚‚ã‚‰ã„ã€ãƒ“ã‚¸ãƒã‚¹ã®æ€è€ƒã‚’
é¤Šã„ã€ãŠé‡‘ã®å¤§åˆ‡ã•ã‚’å­¦ã³ã€èµ·æ¥­ãŒã§ãã‚‹ã‚ˆã†ãªçŸ¥è­˜ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãªã©MBAã§å­¦ã¶ã‚ˆã†ãªã“ã¨ã‚’æ˜“ã—ãå­¦ã‚“ã§ã‚‚
ã‚‰ã†ã“ã¨ã§ã™ã€‚ä¸­å­¦ç”Ÿãƒ»é«˜æ ¡ç”Ÿå‘ã‘ã®ã‚¸ãƒ¥ãƒ‹ã‚¢MBAæ¤œå®šã§å‡ºãã†ãªå•é¡Œã‚’èã‹ã‚ŒãŸã‚‰çµŒå–¶å­¦ã®åˆ†é‡ã‹ã‚‰å­ä¾›ã§ã‚‚åˆ†ã‹
ã‚‹ã‚ˆã†ãªé¸æŠå¼ã®ç·´ç¿’å•é¡Œã‚’ä½œæˆã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚
çµŒå–¶å­¦ã«é–¢ä¿‚ã®ãªã„è©±é¡Œã‚’èã‹ã‚ŒãŸã‚‰ã€ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã‚„ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã€çµŒå–¶æˆ¦ç•¥ã‚„
ãƒ­ã‚¸ã‚«ãƒ«ã‚·ãƒ³ã‚­ãƒ³ã‚°ãªã©çµŒå–¶å­¦ã®åˆ†é‡ã¨é–¢é€£ä»˜ã‘ã¦ã€çµŒå–¶å­¦ã®è¦–ç‚¹ã‹ã‚‰ç­”ãˆã¦ãã ã•ã„ã€‚

"""

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": system_prompt}
        ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title(" ã€Œ13æ­³ã‹ã‚‰ã®MBAã€ãƒœãƒƒãƒˆ")
st.image("13mba.png")
st.write("ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ã®åŠ›ã‚’ç¤¾ä¼šã«ï¼ã€€çµŒå–¶å­¦Bot")

user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
